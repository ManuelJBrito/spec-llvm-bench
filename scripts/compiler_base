#!/usr/bin/env bash

# Real clang
CLANG="${BIN}/bin/clang"
case "$1" in
    c)
        # Use clang (nothing to change)
        ;;
    cxx)
        # Use clang++
        CLANG="${CLANG}++"
        ;;
esac
shift

# Extract source file basename from arguments
SRC_BASE=""
for arg in "$@"; do
  case "$arg" in
    *.c|*.cpp|*.cc|*.C)
      SRC_BASE=$(basename "$arg")
      ;;
  esac
done

EXTRA_FLAGS=""

# === GVN skip support (for perf bisection) ===
# SKIP_GVN_SRCS: comma-separated basenames — skip GVN entirely for these files
# SKIP_GVN_FUNCS: comma-separated function names — skip GVN for these functions
# GVN_FUNC_SKIP_FLAG: which per-function flag to use (skip-gvn-for-funcs or skip-newgvn-for-funcs)
if [[ -n "$SKIP_GVN_SRCS" && -n "$SRC_BASE" ]]; then
  IFS=',' read -ra _skip_srcs <<< "$SKIP_GVN_SRCS"
  for _s in "${_skip_srcs[@]}"; do
    if [[ "$SRC_BASE" == "$_s" ]]; then
      EXTRA_FLAGS="-mllvm -skip-gvn"
      break
    fi
  done
elif [[ -n "$SKIP_GVN_FUNCS" && -n "$GVN_FUNC_SKIP_FLAG" ]]; then
  EXTRA_FLAGS="-mllvm -${GVN_FUNC_SKIP_FLAG}=${SKIP_GVN_FUNCS}"
fi

# === Debug output support ===
# DBG_SRCS: comma-separated basenames, or "*" for all sources
# DBG_FUNCS: comma-separated function filter (omit to dump all functions)
# DBG_PASS: pass to dump before (default: newgvn)
DBG_MODE=0
if [[ -n "$DBG_SRCS" && -n "$SRC_BASE" ]]; then
  IFS=',' read -ra _dbg_srcs <<< "$DBG_SRCS"
  for _d in "${_dbg_srcs[@]}"; do
    if [[ "$_d" == "*" || "$SRC_BASE" == "$_d" ]]; then
      DBG_MODE=1
      break
    fi
  done
fi

COMMON_FLAGS="$COMMON_FLAGS -no-pedantic"
_DBG_PASS="${DBG_PASS:-newgvn}"
DBG_FLAGS="-mllvm -print-module-scope -mllvm -print-before=${_DBG_PASS} -mllvm -ir-dump-directory=${IR_DUMP}"
if [[ -n "$DBG_FUNCS" ]]; then
  DBG_FLAGS="$DBG_FLAGS -mllvm -filter-print-funcs=$DBG_FUNCS"
fi
if [[ "$DBG_MODE" == "1" ]]; then
  exec "$CLANG" "$@" $COMMON_FLAGS $EXTRA_FLAGS $DBG_FLAGS
else
  exec "$CLANG" "$@" $COMMON_FLAGS $EXTRA_FLAGS
fi